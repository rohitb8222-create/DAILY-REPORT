<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWM Live Analytics | </title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        * { font-family: 'Poppins', sans-serif; }
        body { background: #f4f7f6; color: #1e293b; }
        .sidebar { background: #0f172a; color: white; height: 100vh; position: fixed; width: 280px; padding: 20px; z-index: 1000; }
        .main-content { margin-left: 280px; padding: 30px; width: calc(100% - 280px); }
        .glass-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; border: none; }
        .stat-val { font-size: 1.8rem; font-weight: 700; color: #059669; }
        @media print { .sidebar { display: none; } .main-content { margin-left: 0; width: 100%; } }
    </style>
</head>
<body>

<div class="sidebar d-print-none">
    <h4 class="text-info fw-bold">SWM LIVE PRO</h4>
    <p class="small text-white-50">Shivam Bhandari Analytics</p>
    <hr>
    <label class="small fw-bold text-uppercase opacity-50">Filters</label>
    <input type="date" id="dateFilter" class="form-control form-control-sm bg-dark text-white border-secondary mb-3">
    <select id="wardFilter" class="form-select form-select-sm bg-dark text-white border-secondary mb-3">
        <option value="">‡§∏‡§∞‡•ç‡§µ ‡§µ‡•â‡§∞‡•ç‡§°</option>
    </select>
    <button class="btn btn-info w-100 mb-2 fw-bold" onclick="fetchData()">üîÑ ‡§°‡•á‡§ü‡§æ ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡§æ</button>
    <button class="btn btn-danger w-100 fw-bold" onclick="downloadPDF()">üìÑ PDF ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</button>
</div>

<div class="main-content">
    <div id="reportArea">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>SWM Daily Performance</h3>
            <span id="liveStatus" class="badge bg-success">Live from Google Sheets</span>
        </div>

        <div class="row g-3">
            <div class="col-md-6">
                <div class="glass-card text-center border-start border-4 border-success">
                    <p class="text-muted mb-1 fw-bold">TOTAL WET WASTE</p>
                    <div id="totalWet" class="stat-val">0.00</div>
                    <small>Metric Tons (MT)</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="glass-card text-center border-start border-4 border-primary">
                    <p class="text-muted mb-1 fw-bold">TOTAL NET TONNAGE</p>
                    <div id="totalNet" class="stat-val text-primary">0.00</div>
                    <small>Metric Tons (MT)</small>
                </div>
            </div>
        </div>

        <div class="glass-card">
            <canvas id="liveChart" height="100"></canvas>
        </div>

        <div class="glass-card p-0">
            <table class="table table-hover m-0" id="dataTable">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Ward</th>
                        <th>Vehicle</th>
                        <th>Net (MT)</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§ó‡•Å‡§ó‡§≤ ‡§∂‡•Ä‡§ü CSV ‡§≤‡§ø‡§Ç‡§ï ‡§á‡§•‡•á ‡§ü‡§æ‡§ï‡§æ
    const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTdHHQ9sR7MQheZVCwExTeO2E8MTSG4agRIrVlzsg1xY9cyalOj6a2RCvN9aYjCEFUIJH6sv9lQwHSE/pubhtml'; 
    let masterData = [];
    let myChart = null;

    async function fetchData() {
        Papa.parse(sheetURL, {
            download: true,
            header: true,
            complete: function(results) {
                masterData = results.data;
                updateUI();
            }
        });
    }

    function updateUI() {
        const filterDate = document.getElementById('dateFilter').value;
        const filterWard = document.getElementById('wardFilter').value;
        
        const tbody = document.querySelector("#dataTable tbody");
        tbody.innerHTML = "";
        let wetSum = 0;
        let netSum = 0;
        let chartLabels = [];
        let chartData = [];

        // ‡§µ‡•â‡§∞‡•ç‡§° ‡§°‡•ç‡§∞‡•â‡§™‡§°‡§æ‡§ä‡§® ‡§Ö‡§™‡§°‡•á‡§ü (‡§´‡§ï‡•ç‡§§ ‡§è‡§ï‡§¶‡§æ)
        if(document.getElementById('wardFilter').options.length <= 1) {
            const wards = [...new Set(masterData.map(r => r.WARD))].filter(Boolean);
            wards.forEach(w => {
                let opt = new Option(w, w);
                document.getElementById('wardFilter').add(opt);
            });
        }

        masterData.forEach(row => {
            if(!row.DATE) return;
            
            // ‡§°‡•á‡§ü‡§æ ‡§Æ‡•Ö‡§ö‡§ø‡§Ç‡§ó
            const matchDate = !filterDate || row.DATE.includes(filterDate.split('-').reverse().join('-'));
            const matchWard = !filterWard || row.WARD === filterWard;

            if(matchDate && matchWard) {
                const g = parseFloat(row.GROSS_WEIGHT) || 0;
                const t = parseFloat(row.TARE_WEIGHT) || 0;
                const net = (g - t) / 1000;
                const type = (row.SEGRGATION || "").toUpperCase();

                netSum += net;
                if(type.includes("WET")) wetSum += net;

                tbody.innerHTML += `<tr>
                    <td>${row.DATE}</td>
                    <td>${row.WARD}</td>
                    <td>${row.VEHICLENUMBER}</td>
                    <td class="fw-bold text-primary">${net.toFixed(2)}</td>
                    <td><span class="badge ${type.includes('WET')?'bg-success':'bg-secondary'}">${type}</span></td>
                </tr>`;
                
                chartLabels.push(row.VEHICLENUMBER);
                chartData.push(net);
            }
        });

        document.getElementById('totalWet').innerText = wetSum.toFixed(2);
        document.getElementById('totalNet').innerText = netSum.toFixed(2);
        updateChart(chartLabels, chartData);
    }

    function updateChart(labels, data) {
        if(myChart) myChart.destroy();
        const ctx = document.getElementById('liveChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Vehicle-wise Net MT', data: data, backgroundColor: '#3b82f6' }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }

    function downloadPDF() {
        const element = document.getElementById('reportArea');
        const opt = {
            margin: 0.5,
            filename: `SWM_Report_${new Date().toLocaleDateString()}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }

    // ‡§ë‡§ü‡•ã ‡§≤‡•ã‡§°
    window.onload = fetchData;
    document.getElementById('dateFilter').addEventListener('change', updateUI);
    document.getElementById('wardFilter').addEventListener('change', updateUI);
</script>
</body>
</html>
